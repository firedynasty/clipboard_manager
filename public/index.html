<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Basic Vercel React app with hello world functionality"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <title>Basic Vercel App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <!-- Dropbox Integration -->
    <script>
    (function() {
        let dropboxAccessToken = null;
        let dropboxAppKey = '';
        const dbxIsLocalhost = ['localhost', '127.0.0.1'].includes(window.location.hostname);

        // PKCE helpers
        function generateCodeVerifier() {
            const array = new Uint8Array(64);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode(...array))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        async function fetchDropboxAppKey() {
            if (dbxIsLocalhost) {
                return localStorage.getItem('dropbox-app-key') || '';
            }
            try {
                const res = await fetch('/api/dropbox-key');
                const data = await res.json();
                return data.key || '';
            } catch {
                return '';
            }
        }

        // Expose helpers immediately so React can use them
        window.getDropboxAccessToken = function() { return dropboxAccessToken; };

        window.dropboxDownloadFile = async function(path) {
            if (!dropboxAccessToken) return null;
            const response = await fetch('https://content.dropboxapi.com/2/files/download', {
                method: 'POST',
                headers: {
                    Authorization: 'Bearer ' + dropboxAccessToken,
                    'Dropbox-API-Arg': JSON.stringify({ path: path }),
                },
            });
            if (!response.ok) {
                if (response.status === 409) return null;
                throw new Error('Download failed');
            }
            return await response.text();
        };

        window.dropboxUploadFile = async function(path, content) {
            if (!dropboxAccessToken) throw new Error('Not signed into Dropbox');
            const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
                method: 'POST',
                headers: {
                    Authorization: 'Bearer ' + dropboxAccessToken,
                    'Dropbox-API-Arg': JSON.stringify({
                        path: path, mode: { '.tag': 'overwrite' }, mute: true,
                    }),
                    'Content-Type': 'application/octet-stream',
                },
                body: content,
            });
            if (!response.ok) throw new Error('Upload failed');
            return true;
        };

        window.dropboxSignIn = async function() {
            let appKey;
            if (dbxIsLocalhost) {
                appKey = prompt('Enter your Dropbox App Key:');
                if (!appKey) return;
                localStorage.setItem('dropbox-app-key', appKey);
            } else {
                appKey = await fetchDropboxAppKey();
                if (!appKey) { alert('Dropbox App Key not configured on server'); return; }
            }
            dropboxAppKey = appKey;

            const verifier = generateCodeVerifier();
            const challenge = await generateCodeChallenge(verifier);
            sessionStorage.setItem('dropbox_code_verifier', verifier);

            const redirectUri = window.location.origin + window.location.pathname;
            const authUrl = 'https://www.dropbox.com/oauth2/authorize?client_id=' + appKey
                + '&response_type=code&code_challenge=' + challenge
                + '&code_challenge_method=S256&redirect_uri=' + encodeURIComponent(redirectUri)
                + '&token_access_type=online';
            window.location.href = authUrl;
        };

        window.dropboxSignOut = async function() {
            if (dropboxAccessToken) {
                try {
                    await fetch('https://api.dropboxapi.com/2/auth/token/revoke', {
                        method: 'POST',
                        headers: { Authorization: 'Bearer ' + dropboxAccessToken },
                    });
                } catch {}
            }
            dropboxAccessToken = null;
        };

        // Handle OAuth redirect on page load (returns a promise React can await)
        window._dropboxReady = (async function() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            if (!code) return;

            const verifier = sessionStorage.getItem('dropbox_code_verifier');
            const appKey = await fetchDropboxAppKey();
            if (!verifier || !appKey) return;
            dropboxAppKey = appKey;

            const redirectUri = window.location.origin + window.location.pathname;
            const body = new URLSearchParams({
                code,
                grant_type: 'authorization_code',
                client_id: appKey,
                redirect_uri: redirectUri,
                code_verifier: verifier,
            });

            try {
                const res = await fetch('https://api.dropboxapi.com/oauth2/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: body.toString(),
                });
                const data = await res.json();
                if (data.access_token) {
                    dropboxAccessToken = data.access_token;
                    sessionStorage.removeItem('dropbox_code_verifier');
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } catch (err) {
                console.error('Dropbox auth error:', err);
            }
        })();
    })();
    </script>
  </body>
</html>